<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Elite Investor Academy</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#0A2342;
  --navy2:#1F3F70;
  --orange:#FF7300;
  --gold:#d4af37;
  --muted:rgba(255,255,255,.75);
  --card:rgba(255,255,255,.08);
  --border:rgba(212,175,55,.28);
  --bg1:#050507;
  --bg2:#0d0d12;
  --error:#ff6b6b;
  --success:#51cf66;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Poppins,system-ui,Arial,sans-serif;
  color:#fff;
  background:
    radial-gradient(circle at top, rgba(212,175,55,.10), transparent 45%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height:100vh;
}

/* Top bar */
.topbar{
  position:sticky; top:0; z-index:50;
  display:flex; align-items:center; justify-content:space-between;
  gap:14px;
  padding:14px 18px;
  background:rgba(0,0,0,.70);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
}
.brand{
  display:flex; align-items:center; gap:10px;
}
.brand .logo{
  width:34px; height:34px; border-radius:10px;
  background:linear-gradient(145deg, rgba(212,175,55,.28), rgba(255,255,255,.05));
  border:1px solid var(--border);
  box-shadow:0 0 22px rgba(212,175,55,.12);
}
.brand .name{
  font-family:"Playfair Display",serif;
  font-size:1.05rem;
  line-height:1.1;
}
.actions{
  display:flex; gap:10px; flex-wrap:wrap;
}
.btn{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(212,175,55,.22), rgba(255,255,255,.04));
  color:#fff;
  padding:10px 14px;
  border-radius:14px;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex; align-items:center; gap:8px;
  transition:.25s ease;
  font-size:0.9rem;
  border:none;
}
.btn:hover{ box-shadow:0 0 18px rgba(212,175,55,.25); transform:translateY(-1px); }
.btn.primary{
  background:var(--orange);
  border-color:var(--orange);
}
.btn.danger{
  background:rgba(220,53,69,0.3);
  border-color:rgba(220,53,69,0.5);
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:26px 18px 80px;
}

/* Header */
.hero{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
  border-radius:26px;
  padding:22px;
  backdrop-filter:blur(18px);
  margin-bottom:20px;
}
.hero h1{
  margin:0;
  font-family:"Playfair Display",serif;
  font-size:2rem;
}
.hero p{ margin:10px 0 0; color:var(--muted); }

/* Search section */
.search-section{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  border-radius:22px;
  padding:22px;
  margin-bottom:20px;
}
.search-section h2{
  font-size:1.3rem;
  margin-bottom:16px;
  font-family:"Playfair Display",serif;
}
.search-form{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.search-input{
  flex:1;
  min-width:200px;
  padding:12px 16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.30);
  color:#fff;
  border-radius:14px;
  font-size:0.95rem;
}
.search-input::placeholder{
  color:rgba(255,255,255,.5);
}
.search-input:focus{
  outline:none;
  border-color:var(--border);
  box-shadow:0 0 16px rgba(212,175,55,.18);
}

/* User card */
.user-card{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  border-radius:22px;
  padding:22px;
  margin-bottom:20px;
  display:none;
}
.user-card.show{
  display:block;
}
.user-info{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:16px;
  margin-bottom:20px;
}
.info-item{
  padding:12px;
  background:rgba(0,0,0,.25);
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
}
.info-label{
  font-size:0.85rem;
  color:var(--muted);
  margin-bottom:6px;
}
.info-value{
  font-size:1.1rem;
  font-weight:600;
  color:var(--gold);
}

/* Tier selector */
.tier-selector{
  margin:20px 0;
}
.tier-selector label{
  display:block;
  margin-bottom:10px;
  font-weight:600;
}
.tier-select{
  width:100%;
  padding:12px 16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.30);
  color:#fff;
  border-radius:14px;
  font-size:0.95rem;
  cursor:pointer;
}
.tier-select:focus{
  outline:none;
  border-color:var(--border);
  box-shadow:0 0 16px rgba(212,175,55,.18);
}

/* Messages */
.message{
  padding:14px 18px;
  border-radius:14px;
  margin-bottom:16px;
  display:none;
}
.message.show{
  display:block;
}
.message.error{
  background:rgba(220,53,69,0.2);
  border:1px solid rgba(220,53,69,0.5);
  color:var(--error);
}
.message.success{
  background:rgba(40,167,69,0.2);
  border:1px solid rgba(40,167,69,0.5);
  color:var(--success);
}

/* Loading */
.loading{
  text-align:center;
  padding:3rem;
  color:var(--muted);
}
.tabs{ display:flex; gap:10px; flex-wrap:wrap; }
.tab-btn{
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  font-size:0.9rem;
}
.tab-btn.active{
  border-color:var(--border);
  background:linear-gradient(145deg, rgba(212,175,55,.18), rgba(255,255,255,.03));
}
.tab-content{ display:none; }
.tab-content.active{ display:block; }
.loader{
  display:inline-block;
  width:40px;
  height:40px;
  border:4px solid rgba(255,255,255,0.2);
  border-top-color:var(--orange);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:1rem;
}
@keyframes spin{
  to{transform:rotate(360deg);}
}

/* Access denied */
.access-denied{
  text-align:center;
  padding:4rem 2rem;
}
.access-denied h2{
  font-size:2rem;
  margin-bottom:1rem;
  color:var(--error);
}
.access-denied p{
  color:var(--muted);
  margin-bottom:2rem;
}
</style>
</head>

<body>
<!-- 
  ============================================
  ADMIN PANEL - SECURITY NOTICE
  ============================================
  This page is protected by:
  1. Supabase session authentication (checked on load)
  2. Profile role check (must be 'admin')
  3. RLS policies on database (only admins can read audit_log)
  4. API endpoints verify admin role server-side
  
  All admin actions are logged to audit_log table with:
  - Actor (admin user)
  - Action type
  - Target user
  - Metadata (before/after values)
-->

<header class="topbar">
  <div class="brand">
    <div class="logo"></div>
    <div class="name">Elite Investor Academy<br><span style="font-family:Poppins;font-size:.8rem;color:rgba(255,255,255,.75)">Admin Panel</span></div>
  </div>
  <div class="actions">
    <span id="adminEmail" style="color:var(--muted);font-size:0.9rem;"></span>
    <a href="/dashboard.html" class="btn">‚Üê Dashboard</a>
    <button class="btn" id="logoutBtn">Log out</button>
  </div>
</header>

<main class="container">
  <!-- Loading state -->
  <div class="loading" id="loading">
    <div class="loader"></div>
    <p>Checking admin access...</p>
  </div>

  <!-- Access denied -->
  <div class="access-denied" id="accessDenied" style="display:none;">
    <h2>üîí Access Denied</h2>
    <p>You must be an administrator to access this panel.</p>
    <a href="/dashboard.html" class="btn primary">Go to Dashboard</a>
  </div>

  <!-- Admin panel -->
  <div id="adminPanel" style="display:none;">
    <section class="hero">
      <h1>Admin Panel</h1>
      <p>Manage user tiers, entitlements, and view audit log</p>
    </section>

    <div class="message" id="message"></div>

    <div class="tabs" style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
      <button type="button" class="tab-btn active" data-tab="search">User & Tier</button>
      <button type="button" class="tab-btn" data-tab="audit">Audit Log</button>
      <button type="button" class="tab-btn" data-tab="grant">Grant Entitlement</button>
    </div>

    <!-- Tab: User & Tier -->
    <section class="search-section tab-content active" id="tab-search">
      <h2>Search User</h2>
      <form class="search-form" id="searchForm">
        <input type="email" class="search-input" id="emailInput" placeholder="Enter user email" required autocomplete="off">
        <button type="submit" class="btn primary">Search</button>
      </form>
    </section>

    <section class="user-card" id="userCard">
      <h2 style="margin-bottom:16px;font-family:'Playfair Display',serif;">User Details</h2>
      <div class="user-info">
        <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="userEmail">-</div></div>
        <div class="info-item"><div class="info-label">Current Tier</div><div class="info-value" id="currentTier">-</div></div>
        <div class="info-item"><div class="info-label">Role</div><div class="info-value" id="userRole">-</div></div>
        <div class="info-item"><div class="info-label">Member Since</div><div class="info-value" id="memberSince">-</div></div>
      </div>
      <div class="tier-selector">
        <label for="tierSelect">Update Tier</label>
        <select id="tierSelect" class="tier-select">
          <option value="guest">Guest</option>
          <option value="starter">Starter Investor ($29/mo)</option>
          <option value="serious">Serious Investor ($79/mo)</option>
          <option value="elite">Elite / Pro ($149/mo)</option>
          <option value="academy_starter">Academy Starter ($500)</option>
          <option value="academy_pro">Academy Pro ($999)</option>
          <option value="academy_premium">Academy Premium ($1499)</option>
        </select>
      </div>
      <div class="tier-selector">
        <label for="reasonInput">Reason (optional, for audit)</label>
        <input type="text" class="search-input" id="reasonInput" placeholder="e.g. Support ticket #123">
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn primary" id="saveBtn">Save Tier</button>
        <button class="btn" id="cancelBtn">Cancel</button>
      </div>
    </section>

    <!-- Tab: Audit Log -->
    <section class="search-section tab-content" id="tab-audit" style="display:none;">
      <h2>Audit Log</h2>
      <div class="search-form" style="margin-bottom:16px;">
        <select id="auditActionFilter" class="search-input" style="max-width:200px;">
          <option value="">All actions</option>
          <option value="tier_override">Tier override</option>
          <option value="entitlement_grant">Entitlement grant</option>
          <option value="entitlement_claim">Entitlement claim</option>
          <option value="webhook_processed">Webhook processed</option>
          <option value="login">Login</option>
        </select>
        <input type="email" class="search-input" id="auditTargetEmail" placeholder="Target email" style="max-width:220px;">
        <input type="date" class="search-input" id="auditDateFrom" style="max-width:160px;">
        <input type="date" class="search-input" id="auditDateTo" style="max-width:160px;">
        <button type="button" class="btn primary" id="auditLoadBtn">Load</button>
      </div>
      <div class="audit-table-wrap" style="overflow-x:auto;">
        <table class="tier-select" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
          <thead>
            <tr style="border-bottom:1px solid var(--border);">
              <th style="text-align:left;padding:10px;">Date</th>
              <th style="text-align:left;padding:10px;">Action</th>
              <th style="text-align:left;padding:10px;">Actor</th>
              <th style="text-align:left;padding:10px;">Target</th>
              <th style="text-align:left;padding:10px;">Metadata</th>
            </tr>
          </thead>
          <tbody id="auditTableBody"></tbody>
        </table>
      </div>
      <div class="loading" id="auditLoading" style="display:none;"><div class="loader"></div><p>Loading...</p></div>
    </section>

    <!-- Tab: Grant Entitlement -->
    <section class="search-section tab-content" id="tab-grant" style="display:none;">
      <h2>Grant Entitlement</h2>
      <form class="search-form" id="grantForm" style="flex-direction:column;align-items:flex-start;gap:12px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <input type="email" class="search-input" id="grantEmail" placeholder="Target email" required style="min-width:220px;">
          <select id="grantProductKey" class="search-input" style="min-width:200px;">
            <option value="calc_starter">calc_starter (Starter)</option>
            <option value="calc_serious">calc_serious (Serious)</option>
            <option value="calc_elite">calc_elite (Elite)</option>
            <option value="academy_starter">academy_starter</option>
            <option value="academy_pro">academy_pro</option>
            <option value="academy_premium">academy_premium</option>
          </select>
          <input type="datetime-local" class="search-input" id="grantExpiresAt" placeholder="Expires at (optional)" style="min-width:200px;">
          <span style="color:var(--muted);font-size:0.9rem;">Leave expiry empty for no expiration</span>
        </div>
        <button type="submit" class="btn primary">Grant Entitlement</button>
      </form>
    </section>
  </div>
</main>

<!-- 
  ============================================
  SECURITY DECISION: ES Module Import
  ============================================
  Using ES modules to load Supabase client and admin logic.
  This ensures modern JavaScript execution with proper scoping.
  All authentication checks happen before any admin actions.
-->
<script type="module" src="admin.js"></script>

</body>
</html>
