<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protected Calculator - Elite Investor Academy</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: #0A2342;
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding: 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.header h1 {
  font-size: 1.2rem;
  font-weight: 600;
}

.header .actions {
  display: flex;
  gap: 0.5rem;
}

.btn {
  padding: 0.5rem 1rem;
  background: rgba(255, 115, 0, 0.2);
  border: 1px solid rgba(255, 115, 0, 0.3);
  color: #fff;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s;
}

.btn:hover {
  background: rgba(255, 115, 0, 0.3);
}

.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
}

.loading {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 1rem;
}

.loader {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255, 255, 255, 0.2);
  border-top-color: #FF7300;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 1rem;
  padding: 2rem;
  text-align: center;
}

.error h2 {
  font-size: 1.5rem;
  color: #ff6b6b;
}

.error p {
  color: rgba(255, 255, 255, 0.7);
  max-width: 500px;
}

.error .btn {
  margin-top: 1rem;
  background: #FF7300;
  border-color: #FF7300;
}

.error .btn:hover {
  background: #ff8500;
}

.calculator-frame {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  display: none;
}

.calculator-frame.show {
  display: block;
}
</style>
</head>

<body>
<div class="header">
  <h1><span data-brand-company>Elite Investor Academy</span> - Calculator</h1>
  <div class="actions">
    <a href="/dashboard.html" class="btn">‚Üê Dashboard</a>
  </div>
</div>

<div class="container">
  <div class="loading" id="loading">
    <div class="loader"></div>
    <p>Verifying access...</p>
  </div>
  
  <div class="error" id="error" style="display: none;">
    <h2>üîí Access Restricted</h2>
    <p id="errorMessage"></p>
    <a href="/dashboard.html" class="btn">Go to Dashboard</a>
    <a href="/index.html" class="btn" style="margin-top: 0.5rem;">View Pricing</a>
  </div>
  
  <iframe 
    id="calculatorFrame" 
    class="calculator-frame" 
    src=""
    allow="fullscreen"
    sandbox="allow-scripts allow-forms allow-same-origin"
    title="Calculator"
  ></iframe>
</div>

<script src="auth/config.js"></script>
<script type="module" src="/js/analytics-error-boundary.js"></script>
<script type="module">
  import { loadAndApplyBranding } from '/js/branding-loader.js';
  loadAndApplyBranding({ companySelector: '[data-brand-company]' });
</script>
<script type="module" src="/js/analytics-pageview.js" data-page="protected"></script>
<script type="module">
// Supabase with cross-subdomain cookie storage (invest + dealcheck share session)
const { getSupabase } = await import('./js/supabase-auth-cookies.js');

const supabase = await getSupabase();

// Tool id -> path and required tier (tier matrix only; no internal tools).
// guest: none | starter: offer, brrrr | serious: + dealcheck, rehab, pwt, wholesale | elite: + commercial | admin: all
const TOOL_MAP = {
  offer: { path: '/tools/offer.html', tier: 'starter' },
  brrrr: { path: '/tools/brrrr.html', tier: 'starter' },
  dealcheck: { path: '/tools/dealcheck.html', tier: 'serious' },
  rehab: { path: '/tools/rehabtracker.html', tier: 'serious' },
  rehabtracker: { path: '/tools/rehabtracker.html', tier: 'serious' },
  pwt: { path: '/tools/pwt.html', tier: 'serious' },
  wholesale: { path: '/tools/wholesale.html', tier: 'serious' },
  commercial: { path: '/tools/commercial.html', tier: 'elite' }
};

const TIER_RANK = {
  guest: 0, starter: 1, serious: 2, elite: 3,
  academy_starter: 1, academy_pro: 2, academy_premium: 3,
  admin: 999  // Role override: bypasses tier gating
};

const urlParams = new URLSearchParams(window.location.search);
const toolId = urlParams.get('tool') || urlParams.get('calc');
const toolConfig = toolId ? TOOL_MAP[toolId] : null;
const calculatorUrl = toolConfig ? toolConfig.path : (urlParams.get('url') || urlParams.get('calc'));
const requiredTier = toolConfig ? toolConfig.tier : (urlParams.get('tier') || 'starter');

function canAccess(userTier, minTier) {
  const u = userTier === undefined || userTier === null ? 'guest' : userTier;
  const userRank = TIER_RANK[u] ?? 0;
  const requiredRank = TIER_RANK[minTier] ?? 999;
  return userRank >= requiredRank;
}

function prettyTier(tier) {
  const names = {
    guest: 'Guest',
    starter: 'Starter Investor',
    serious: 'Serious Investor',
    elite: 'Elite / Pro',
    academy_starter: 'Academy Starter',
    academy_pro: 'Academy Pro',
    academy_premium: 'Academy Premium',
    admin: 'Admin'
  };
  return names[tier] || tier;
}

// Main verification
(async () => {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const errorMessage = document.getElementById('errorMessage');
  const calculatorFrame = document.getElementById('calculatorFrame');

  // Referrer check: block embedding from unknown origins (iframe hardening)
  const allowedOrigins = [
    'https://invest.elitesolutionsnetwork.com',
    'https://dealcheck.elitesolutionsnetwork.com',
    'http://localhost:3000',
    'http://localhost:5173',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:5173'
  ];
  const ref = document.referrer;
  if (ref) {
    try {
      const refOrigin = new URL(ref).origin;
      if (!allowedOrigins.includes(refOrigin)) {
        window.location.replace('/index.html');
        return;
      }
    } catch (e) {
      // Invalid referrer URL - allow (direct access has empty referrer)
    }
  }

  try {
    // Only allow known gated tools; redirect to pricing for unknown tool IDs
    if (toolId && !toolConfig) {
      window.location.replace('/index.html');
      return;
    }
    // Check authentication
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (!session) {
      const redirect = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.replace(redirect ? '/login.html?redirect=' + redirect : '/login.html');
      return;
    }
    
    const user = session.user;
    // Role: never override admin; check profiles + member_profiles (Supabase source of truth)
    let role = user?.user_metadata?.role ?? user?.app_metadata?.role ?? 'user';
    try {
      const { data: p } = await supabase.from('profiles').select('role').eq('id', user.id).maybeSingle();
      if (p?.role === 'admin') role = 'admin';
    } catch (_) {}
    try {
      const { data: mp } = await supabase.from('member_profiles').select('role').eq('id', user.id).maybeSingle();
      if (mp?.role === 'admin') role = 'admin';
    } catch (_) {}
    let userTier = role === 'admin' ? 'admin' : null;
    if (userTier !== 'admin') {
      const now = new Date().toISOString();
      const { data: override } = await supabase.from('tier_overrides').select('override_tier').eq('user_id', user.id).or('expires_at.is.null,expires_at.gt.' + now).order('created_at', { ascending: false }).limit(1).maybeSingle();
      if (override?.override_tier) userTier = override.override_tier;
      else {
        const { data: memberProfile } = await supabase.from('member_profiles').select('tier').eq('id', user.id).single();
        if (memberProfile?.tier) userTier = memberProfile.tier;
        else {
          const { data: legacyProfile } = await supabase.from('profiles').select('tier').eq('id', user.id).single();
          userTier = legacyProfile?.tier ?? user?.user_metadata?.tier ?? user?.app_metadata?.tier ?? 'guest';
        }
      }
    }

    // Check tier access (or add-on subscription)
    let hasAccess = canAccess(userTier, requiredTier);
    if (!hasAccess && toolId) {
      try {
        const { hasToolAccess } = await import('/js/entitlements.js');
        hasAccess = await hasToolAccess({ id: user.id, tier: userTier }, toolId);
      } catch (_) {}
    }
    if (!hasAccess) {
      window.location.replace('/index.html');
      return;
    }
    
    if (!calculatorUrl) {
      loading.style.display = 'none';
      error.style.display = 'flex';
      errorMessage.textContent = 'No calculator specified. Use /protected.html?tool=offer (or brrrr, rehab, pwt).';
      return;
    }

    // Optional: check active entitlements not expired (server is source of truth; this is UX)
    // Admins bypass entitlement check (full access)
    const isAdmin = role === 'admin';
    const { data: entitlements } = await supabase
      .from('entitlements')
      .select('id, expires_at, status')
      .eq('user_id', session.user.id)
      .eq('status', 'active');
    const now = new Date().toISOString();
    const hasValidEntitlement = isAdmin || (entitlements || []).some(
      (e) => !e.expires_at || e.expires_at > now
    );
    if (!hasValidEntitlement && (entitlements || []).length > 0) {
      loading.style.display = 'none';
      error.style.display = 'flex';
      errorMessage.textContent = 'Your membership has expired. Please renew to continue.';
      return;
    }
    
    calculatorFrame.src = calculatorUrl;
    loading.style.display = 'none';
    calculatorFrame.classList.add('show');
    
  } catch (err) {
    console.warn('[protected] verify failed:', err?.message || err);
    loading.style.display = 'none';
    error.style.display = 'flex';
    errorMessage.textContent = (err && err.message) ? err.message : 'An error occurred while verifying access. Please try again.';
    return;
  }
})().catch((err) => {
  console.warn('[protected] init failed:', err?.message || err);
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'flex';
  document.getElementById('errorMessage').textContent = 'Something went wrong. Please try again or log in.';
});
</script>

</body>
</html>
