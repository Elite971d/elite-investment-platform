<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Elite Investor Academy</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%230A2342'/><text x='16' y='22' font-size='20' text-anchor='middle' fill='%23FF7300' font-family='sans-serif'>E</text></svg>">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#0A2342;
  --navy2:#1F3F70;
  --orange:#FF7300;
  --gold:#d4af37;
  --muted:rgba(255,255,255,.75);
  --card:rgba(255,255,255,.08);
  --border:rgba(212,175,55,.28);
  --bg1:#050507;
  --bg2:#0d0d12;
  --error:#ff6b6b;
  --success:#51cf66;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Poppins,system-ui,Arial,sans-serif;
  color:#fff;
  background:
    radial-gradient(circle at top, rgba(212,175,55,.10), transparent 45%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height:100vh;
}

/* Top bar */
.topbar{
  position:sticky; top:0; z-index:50;
  display:flex; align-items:center; justify-content:space-between;
  gap:14px;
  padding:14px 18px;
  background:rgba(0,0,0,.70);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
}
.brand{
  display:flex; align-items:center; gap:10px;
}
.brand .logo{
  width:34px; height:34px; border-radius:10px;
  background:linear-gradient(145deg, rgba(212,175,55,.28), rgba(255,255,255,.05));
  border:1px solid var(--border);
  box-shadow:0 0 22px rgba(212,175,55,.12);
}
.brand .name{
  font-family:"Playfair Display",serif;
  font-size:1.05rem;
  line-height:1.1;
}
.actions{
  display:flex; gap:10px; flex-wrap:wrap;
}
.btn{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(212,175,55,.22), rgba(255,255,255,.04));
  color:#fff;
  padding:10px 14px;
  border-radius:14px;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex; align-items:center; gap:8px;
  transition:.25s ease;
  font-size:0.9rem;
  border:none;
}
.btn:hover{ box-shadow:0 0 18px rgba(212,175,55,.25); transform:translateY(-1px); }
.btn.primary{
  background:var(--orange);
  border-color:var(--orange);
}
.btn.danger{
  background:rgba(220,53,69,0.3);
  border-color:rgba(220,53,69,0.5);
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:26px 18px 80px;
}

/* Header */
.hero{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
  border-radius:26px;
  padding:22px;
  backdrop-filter:blur(18px);
  margin-bottom:20px;
}
.hero h1{
  margin:0;
  font-family:"Playfair Display",serif;
  font-size:2rem;
}
.hero p{ margin:10px 0 0; color:var(--muted); }

/* Search section */
.search-section{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  border-radius:22px;
  padding:22px;
  margin-bottom:20px;
}
.search-section h2{
  font-size:1.3rem;
  margin-bottom:16px;
  font-family:"Playfair Display",serif;
}
.search-form{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.search-input{
  flex:1;
  min-width:200px;
  padding:12px 16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.30);
  color:#fff;
  border-radius:14px;
  font-size:0.95rem;
}
.search-input::placeholder{
  color:rgba(255,255,255,.5);
}
.search-input:focus{
  outline:none;
  border-color:var(--border);
  box-shadow:0 0 16px rgba(212,175,55,.18);
}

/* User card */
.user-card{
  border:1px solid var(--border);
  background:linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  border-radius:22px;
  padding:22px;
  margin-bottom:20px;
  display:none;
}
.user-card.show{
  display:block;
}
.user-info{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:16px;
  margin-bottom:20px;
}
.info-item{
  padding:12px;
  background:rgba(0,0,0,.25);
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
}
.info-label{
  font-size:0.85rem;
  color:var(--muted);
  margin-bottom:6px;
}
.info-value{
  font-size:1.1rem;
  font-weight:600;
  color:var(--gold);
}

/* Tier selector */
.tier-selector{
  margin:20px 0;
}
.tier-selector label{
  display:block;
  margin-bottom:10px;
  font-weight:600;
}
.tier-select{
  width:100%;
  padding:12px 16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.30);
  color:#fff;
  border-radius:14px;
  font-size:0.95rem;
  cursor:pointer;
}
.tier-select:focus{
  outline:none;
  border-color:var(--border);
  box-shadow:0 0 16px rgba(212,175,55,.18);
}

/* Messages */
.message{
  padding:14px 18px;
  border-radius:14px;
  margin-bottom:16px;
  display:none;
}
.message.show{
  display:block;
}
.message.error{
  background:rgba(220,53,69,0.2);
  border:1px solid rgba(220,53,69,0.5);
  color:var(--error);
}
.message.success{
  background:rgba(40,167,69,0.2);
  border:1px solid rgba(40,167,69,0.5);
  color:var(--success);
}

/* Loading */
.loading{
  text-align:center;
  padding:3rem;
  color:var(--muted);
}
.tabs{ display:flex; gap:10px; flex-wrap:wrap; }
.tab-btn{
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  font-size:0.9rem;
}
.tab-btn.active{
  border-color:var(--border);
  background:linear-gradient(145deg, rgba(212,175,55,.18), rgba(255,255,255,.03));
}
.tab-content{ display:none; }
.tab-content.active{ display:block; }
.loader{
  display:inline-block;
  width:40px;
  height:40px;
  border:4px solid rgba(255,255,255,0.2);
  border-top-color:var(--orange);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:1rem;
}
@keyframes spin{
  to{transform:rotate(360deg);}
}

/* Access denied */
.access-denied{
  text-align:center;
  padding:4rem 2rem;
}
.access-denied h2{
  font-size:2rem;
  margin-bottom:1rem;
  color:var(--error);
}
.access-denied p{
  color:var(--muted);
  margin-bottom:2rem;
}
</style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo"></div>
    <div class="name">Elite Investor Academy<br><span style="font-family:Poppins;font-size:.8rem;color:rgba(255,255,255,.75)">Admin Panel</span></div>
  </div>
  <div class="actions">
    <span style="margin-right:12px;font-size:0.85rem;color:var(--gold);">Role: Admin ¬∑ Access: Full</span>
    <span id="adminEmail" style="color:var(--muted);font-size:0.9rem;"></span>
    <a href="dashboard.html" class="btn">‚Üê Dashboard</a>
    <button class="btn" id="logoutBtn">Log out</button>
  </div>
</header>

<main class="container">
  <!-- Loading state -->
  <div class="loading" id="loading">
    <div class="loader"></div>
    <p>Checking admin access...</p>
  </div>

  <!-- Access denied -->
  <div class="access-denied" id="accessDenied" style="display:none;">
    <h2>üîí Access Denied</h2>
    <p>You must be an administrator to access this panel.</p>
    <a href="dashboard.html" class="btn primary">Go to Dashboard</a>
  </div>

  <!-- Admin panel -->
  <div id="adminPanel" style="display:none;">
    <section class="hero">
      <h1>Admin Panel</h1>
      <p>Manage user tiers, entitlements, and view audit log</p>
    </section>

    <div class="message" id="message"></div>

    <div class="tabs" style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
      <button type="button" class="tab-btn active" data-tab="search">User & Tier</button>
      <button type="button" class="tab-btn" data-tab="override">Override Panel</button>
      <button type="button" class="tab-btn" data-tab="audit">Audit Log</button>
      <button type="button" class="tab-btn" data-tab="grant">Grant Entitlement</button>
      <button type="button" class="tab-btn" data-tab="usage">Usage Analytics</button>
    </div>

    <!-- Tab: User & Tier -->
    <section class="search-section tab-content active" id="tab-search">
      <h2>Search User</h2>
      <form class="search-form" id="searchForm">
        <input type="email" class="search-input" id="emailInput" placeholder="Enter user email" required autocomplete="off">
        <button type="submit" class="btn primary">Search</button>
      </form>
    </section>

    <section class="user-card" id="userCard">
      <h2 style="margin-bottom:16px;font-family:'Playfair Display',serif;">User Details</h2>
      <div class="user-info">
        <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="userEmail">-</div></div>
        <div class="info-item"><div class="info-label">Profile Tier</div><div class="info-value" id="currentTier">-</div></div>
        <div class="info-item"><div class="info-label">Role</div><div class="info-value" id="userRole">-</div></div>
        <div class="info-item"><div class="info-label">Member Since</div><div class="info-value" id="memberSince">-</div></div>
      </div>
      <!-- Active tier override badge -->
      <div id="activeOverrideBlock" class="override-badge-block" style="display:none; margin:16px 0; padding:14px; background:rgba(212,175,55,.12); border:1px solid var(--border); border-radius:14px;">
        <div class="info-label" style="margin-bottom:6px;">Active tier override</div>
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:10px;">
          <span id="activeOverrideTier" class="pill" style="font-weight:600;"></span>
          <span id="activeOverrideExpiry" style="color:var(--muted);font-size:0.9rem;"></span>
          <button type="button" class="btn danger" id="removeOverrideBtn">Remove override</button>
        </div>
      </div>
      <!-- Set tier override -->
      <div class="tier-selector" style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,.1);">
        <label style="display:block;margin-bottom:10px;font-weight:600;">Set tier override (optional expiry)</label>
        <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:12px;">
          <div style="min-width:160px;">
            <label for="overrideTierSelect" style="font-size:0.85rem;color:var(--muted);">Override tier</label>
            <select id="overrideTierSelect" class="tier-select">
              <option value="guest">Guest</option>
              <option value="starter">Starter</option>
              <option value="serious">Serious</option>
              <option value="elite">Elite</option>
            </select>
          </div>
          <div style="flex:1;min-width:180px;">
            <label for="overrideReasonInput" style="font-size:0.85rem;color:var(--muted);">Reason</label>
            <input type="text" class="search-input" id="overrideReasonInput" placeholder="e.g. Support ticket #123">
          </div>
          <div style="min-width:180px;">
            <label for="overrideExpiresAt" style="font-size:0.85rem;color:var(--muted);">Expires (optional)</label>
            <input type="datetime-local" class="search-input" id="overrideExpiresAt">
          </div>
          <button type="button" class="btn primary" id="applyOverrideBtn">Apply override</button>
        </div>
      </div>
      <!-- Update profile tier (base) -->
      <div class="tier-selector">
        <label for="tierSelect">Update profile tier (base)</label>
        <select id="tierSelect" class="tier-select">
          <option value="guest">Guest</option>
          <option value="starter">Starter Investor ($29/mo)</option>
          <option value="serious">Serious Investor ($79/mo)</option>
          <option value="elite">Elite / Pro ($149/mo)</option>
        </select>
      </div>
      <div class="tier-selector">
        <label for="reasonInput">Reason (required for audit)</label>
        <input type="text" class="search-input" id="reasonInput" placeholder="e.g. Support ticket #123" required>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn primary" id="saveBtn">Save profile tier</button>
        <button class="btn" id="cancelBtn">Cancel</button>
      </div>
    </section>

    <!-- Tab: Override Panel (Member vs Internal tools separation) -->
    <section class="search-section tab-content" id="tab-override" style="display:none;">
      <h2>Override Panel</h2>
      <p style="color:var(--muted);margin-bottom:20px;">Member tools appear in dashboards and pricing. Internal tools are admin-granted only and never shown to members.</p>

      <div class="override-section" style="margin-bottom:28px;padding:20px;border:1px solid var(--border);border-radius:22px;background:rgba(255,255,255,.04);">
        <h3 style="font-size:1.15rem;margin-bottom:12px;font-family:'Playfair Display',serif;">Member tools</h3>
        <p style="color:var(--muted);font-size:0.9rem;margin-bottom:12px;">Calculators and Academy access. Use the <strong>User & Tier</strong> tab to override a member&apos;s tier to change their access. These never include internal tools.</p>
        <ul id="memberToolsList" style="list-style:none;display:flex;flex-wrap:wrap;gap:8px;"></ul>
      </div>

      <div class="override-section" style="margin-bottom:28px;padding:20px;border:1px solid rgba(212,175,55,.4);border-radius:22px;background:rgba(212,175,55,.06);">
        <h3 style="font-size:1.15rem;margin-bottom:12px;font-family:'Playfair Display',serif;">Internal tools</h3>
        <p style="color:var(--muted);font-size:0.9rem;margin-bottom:16px;">Grant or revoke access manually. A reason is required for every action. Internal tools never appear in member dashboards or pricing.</p>
        <div id="internalToolsBlock"></div>
      </div>
    </section>

    <!-- Tab: Audit Log -->
    <section class="search-section tab-content" id="tab-audit" style="display:none;">
      <h2>Audit Log</h2>
      <div class="search-form" style="margin-bottom:16px;">
        <select id="auditActionFilter" class="search-input" style="max-width:200px;">
          <option value="">All actions</option>
          <option value="TIER_CHANGE">TIER_CHANGE</option>
          <option value="TIER_OVERRIDE_SET">TIER_OVERRIDE_SET</option>
          <option value="TIER_OVERRIDE_REMOVED">TIER_OVERRIDE_REMOVED</option>
          <option value="GRANT">GRANT</option>
          <option value="REVOKE">REVOKE</option>
        </select>
        <input type="email" class="search-input" id="auditTargetEmail" placeholder="Target email" style="max-width:220px;">
        <input type="date" class="search-input" id="auditDateFrom" style="max-width:160px;">
        <input type="date" class="search-input" id="auditDateTo" style="max-width:160px;">
        <button type="button" class="btn primary" id="auditLoadBtn">Load</button>
      </div>
      <div class="audit-table-wrap" style="overflow-x:auto;">
        <table class="tier-select" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
          <thead>
            <tr style="border-bottom:1px solid var(--border);">
              <th style="text-align:left;padding:10px;">Date</th>
              <th style="text-align:left;padding:10px;">Action</th>
              <th style="text-align:left;padding:10px;">Actor</th>
              <th style="text-align:left;padding:10px;">Target</th>
              <th style="text-align:left;padding:10px;">Details</th>
            </tr>
          </thead>
          <tbody id="auditTableBody"></tbody>
        </table>
      </div>
      <div class="loading" id="auditLoading" style="display:none;"><div class="loader"></div><p>Loading...</p></div>
    </section>

    <!-- Tab: Grant Entitlement (member product keys only; internal tools use Override Panel) -->
    <section class="search-section tab-content" id="tab-grant" style="display:none;">
      <h2>Grant Entitlement</h2>
      <p style="color:var(--muted);margin-bottom:16px;">Member products only. For internal tools (e.g. Investor Buy Box), use the <strong>Override Panel</strong> tab.</p>
      <form class="search-form" id="grantForm" style="flex-direction:column;align-items:flex-start;gap:12px;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <input type="email" class="search-input" id="grantEmail" placeholder="Target email" required style="min-width:220px;">
          <select id="grantProductKey" class="search-input" style="min-width:200px;">
            <option value="calc_starter">calc_starter (Starter)</option>
            <option value="calc_serious">calc_serious (Serious)</option>
            <option value="calc_elite">calc_elite (Elite)</option>
            <option value="academy_starter">academy_starter</option>
            <option value="academy_pro">academy_pro</option>
            <option value="academy_premium">academy_premium</option>
          </select>
          <input type="datetime-local" class="search-input" id="grantExpiresAt" placeholder="Expires at (optional)" style="min-width:200px;">
          <span style="color:var(--muted);font-size:0.9rem;">Leave expiry empty for no expiration</span>
        </div>
        <div style="width:100%;max-width:400px;">
          <label for="grantReason" style="display:block;margin-bottom:6px;font-weight:600;">Reason (required)</label>
          <input type="text" class="search-input" id="grantReason" placeholder="e.g. Support ticket #123" required style="width:100%;">
        </div>
        <button type="submit" class="btn primary">Grant Entitlement</button>
      </form>
    </section>

    <!-- Tab: Usage Analytics -->
    <section class="search-section tab-content" id="tab-usage" style="display:none;">
      <h2>Usage Analytics</h2>
      <p style="color:var(--muted);margin-bottom:16px;">Tool usage per user, popularity, tier patterns. Admins can read usage_logs.</p>
      <div style="margin-bottom:16px;">
        <button type="button" class="btn primary" id="usageLoadBtn">Load Usage Stats</button>
        <button type="button" class="btn" id="usageExportCsv">Export CSV</button>
      </div>
      <div id="usageStats" style="display:none;">
        <table class="tier-select" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
          <thead>
            <tr style="border-bottom:1px solid var(--border);">
              <th style="text-align:left;padding:10px;">Tool</th>
              <th style="text-align:right;padding:10px;">Count</th>
            </tr>
          </thead>
          <tbody id="usageTableBody"></tbody>
        </table>
        <p style="margin-top:12px;color:var(--muted);font-size:0.9rem;" id="usageTotal"></p>
      </div>
      <div class="loading" id="usageLoading" style="display:none;"><div class="loader"></div><p>Loading...</p></div>
    </section>
  </div>
</main>

<script src="auth/config.js"></script>
<script type="module">
// Load Supabase from CDN
const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
const { getMemberTools } = await import('./js/tools-config.js');
const { getInternalTools } = await import('./js/tools-config.js');

// Config: auth/config.js (window) or build env, then placeholder
const SUPABASE_URL = (typeof window !== 'undefined' && window.__SUPABASE_URL__) || import.meta.env?.VITE_SUPABASE_URL || 'https://YOUR_PROJECT_ID.supabase.co';
const SUPABASE_ANON_KEY = (typeof window !== 'undefined' && window.__SUPABASE_ANON_KEY__) || import.meta.env?.VITE_SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Tier display names
function prettyTier(tier) {
  const names = {
    guest: 'Guest',
    starter: 'Starter Investor',
    serious: 'Serious Investor',
    elite: 'Elite / Pro',
    academy_starter: 'Academy Starter',
    academy_pro: 'Academy Pro',
    academy_premium: 'Academy Premium'
  };
  return names[tier] || tier;
}

// Admin = user_metadata.role OR app_metadata.role (no DB lookup)
function isAdmin(user) {
  return user?.user_metadata?.role === 'admin' || user?.app_metadata?.role === 'admin';
}

// Show message
function showMessage(text, type = 'success') {
  const message = document.getElementById('message');
  message.textContent = text;
  message.className = `message ${type} show`;
  setTimeout(() => {
    message.classList.remove('show');
  }, 5000);
}

// Populate Override Panel: Member tools list + Internal tools (grant/revoke with required reason)
function renderOverridePanel() {
  const memberList = document.getElementById('memberToolsList');
  const internalBlock = document.getElementById('internalToolsBlock');
  if (!memberList || !internalBlock) return;

  const memberTools = getMemberTools();
  memberList.innerHTML = '';
  memberTools.forEach(t => {
    const li = document.createElement('li');
    li.className = 'pill';
    li.style.cssText = 'font-size:.75rem;padding:6px 12px;border-radius:999px;border:1px solid var(--border);color:var(--gold);background:rgba(0,0,0,.25);';
    li.textContent = t.name;
    memberList.appendChild(li);
  });
  const academyLi = document.createElement('li');
  academyLi.className = 'pill';
  academyLi.style.cssText = 'font-size:.75rem;padding:6px 12px;border-radius:999px;border:1px solid var(--border);color:var(--gold);background:rgba(0,0,0,.25);';
  academyLi.textContent = 'Investor Academy access';
  memberList.appendChild(academyLi);

  const internalTools = getInternalTools();
  internalBlock.innerHTML = '';
  internalTools.forEach(tool => {
    const card = document.createElement('div');
    card.className = 'override-section';
    card.style.cssText = 'margin-bottom:20px;padding:16px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(0,0,0,.2);';
    card.innerHTML = '<h4 style="margin:0 0 12px;font-size:1rem;">' + escapeHtml(tool.name) + '</h4>' +
      '<p style="color:var(--muted);font-size:0.85rem;margin-bottom:14px;">' + escapeHtml(tool.description) + '</p>' +
      '<div class="internal-actions" style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;">' +
      '<div><label style="display:block;font-size:0.85rem;margin-bottom:4px;">Target email</label><input type="email" class="search-input internal-email" placeholder="user@example.com" style="min-width:200px;"></div>' +
      '<div><label style="display:block;font-size:0.85rem;margin-bottom:4px;">Reason (required)</label><input type="text" class="search-input internal-reason" placeholder="e.g. Support ticket #123" style="min-width:220px;"></div>' +
      '<div style="display:flex;gap:8px;"><button type="button" class="btn primary internal-grant-btn" data-product-key="' + escapeHtml(tool.productKey) + '">Grant access</button>' +
      '<button type="button" class="btn danger internal-revoke-btn" data-product-key="' + escapeHtml(tool.productKey) + '">Revoke access</button></div>' +
      '</div>';
    internalBlock.appendChild(card);
  });

  internalBlock.querySelectorAll('.internal-grant-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('.override-section');
      const email = card.querySelector('.internal-email').value.trim().toLowerCase();
      const reason = card.querySelector('.internal-reason').value.trim();
      const productKey = btn.dataset.productKey;
      if (!email || !reason) {
        showMessage('Email and reason are required for grant.', 'error');
        return;
      }
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      const { data: profile } = await supabase.from('member_profiles').select('id').eq('email', email).single();
      if (!profile?.id) {
        showMessage('User not found in member_profiles.', 'error');
        return;
      }
      const { error: err } = await supabase.from('entitlements').insert({
        user_id: profile.id,
        email,
        product_key: productKey,
        status: 'active',
        source: 'admin_internal'
      });
      if (err) {
        showMessage('Failed to grant: ' + err.message, 'error');
        return;
      }
      await supabase.from('audit_logs').insert({
        actor_id: session.user.id,
        action: 'GRANT',
        target_user_id: profile.id,
        meta: { product_key: productKey, reason, target_email: email, actor_email: session.user.email }
      });
      showMessage('Internal access granted.', 'success');
      card.querySelector('.internal-email').value = '';
      card.querySelector('.internal-reason').value = '';
    });
  });

  internalBlock.querySelectorAll('.internal-revoke-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('.override-section');
      const email = card.querySelector('.internal-email').value.trim().toLowerCase();
      const reason = card.querySelector('.internal-reason').value.trim();
      const productKey = btn.dataset.productKey;
      if (!email || !reason) {
        showMessage('Email and reason are required for revoke.', 'error');
        return;
      }
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      const { data: profile } = await supabase.from('member_profiles').select('id').eq('email', email).single();
      if (!profile?.id) {
        showMessage('User not found in member_profiles.', 'error');
        return;
      }
      const { data: rows } = await supabase.from('entitlements').select('id').eq('user_id', profile.id).eq('product_key', productKey).eq('status', 'active');
      if (!rows || rows.length === 0) {
        showMessage('No active entitlement found to revoke.', 'error');
        return;
      }
      const { error: err } = await supabase.from('entitlements').update({ status: 'canceled' }).eq('user_id', profile.id).eq('product_key', productKey);
      if (err) {
        showMessage('Failed to revoke: ' + err.message, 'error');
        return;
      }
      await supabase.from('audit_logs').insert({
        actor_id: session.user.id,
        action: 'REVOKE',
        target_user_id: profile.id,
        meta: { product_key: productKey, reason, target_email: email, actor_email: session.user.email }
      });
      showMessage('Internal access revoked.', 'success');
      card.querySelector('.internal-email').value = '';
      card.querySelector('.internal-reason').value = '';
    });
  });
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
function escapeHtmlAttr(s) {
  if (s == null || s === '') return '';
  return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Main initialization
(async () => {
  const loading = document.getElementById('loading');
  const accessDenied = document.getElementById('accessDenied');
  const adminPanel = document.getElementById('adminPanel');
  
  let session, sessionError;
  try {
    const result = await supabase.auth.getSession();
    session = result.data?.session;
    sessionError = result.error;
  } catch (err) {
    console.warn('[admin] getSession failed:', err?.message || err);
    loading.style.display = 'none';
    window.location.replace('/login.html');
    return;
  }
  
  if (sessionError || !session) {
    loading.style.display = 'none';
    window.location.replace('/login.html?redirect=' + encodeURIComponent(window.location.href));
    return;
  }
  
  // Check admin from auth metadata only
  if (!isAdmin(session.user)) {
    loading.style.display = 'none';
    accessDenied.style.display = 'block';
    return;
  }
  
  // User is admin - show panel
  loading.style.display = 'none';
  adminPanel.style.display = 'block';
  document.getElementById('adminEmail').textContent = session.user.email;
  renderOverridePanel();
  
  // Current searched user id (for override/save)
  let currentUserId = null;

  // Load active override for user and show badge
  async function loadActiveOverride(userId) {
    const now = new Date().toISOString();
    const { data: rows } = await supabase
      .from('tier_overrides')
      .select('id, override_tier, reason, expires_at, created_at')
      .eq('user_id', userId)
      .or('expires_at.is.null,expires_at.gt.' + now)
      .order('created_at', { ascending: false })
      .limit(1);
    const override = rows && rows[0] ? rows[0] : null;
    const block = document.getElementById('activeOverrideBlock');
    if (override) {
      block.style.display = 'block';
      document.getElementById('activeOverrideTier').textContent = prettyTier(override.override_tier);
      document.getElementById('activeOverrideExpiry').textContent = override.expires_at
        ? 'Expires: ' + new Date(override.expires_at).toLocaleString()
        : 'No expiry';
    } else {
      block.style.display = 'none';
    }
    return override;
  }

  // Search form handler (member_profiles)
  document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('emailInput').value.trim().toLowerCase();
    if (!email) return;

    const { data: profile, error } = await supabase
      .from('member_profiles')
      .select('*')
      .eq('email', email)
      .single();

    if (error || !profile) {
      showMessage('User not found. Check the email or ensure member_profiles exists.', 'error');
      document.getElementById('userCard').classList.remove('show');
      return;
    }

    currentUserId = profile.id;
    document.getElementById('userEmail').textContent = profile.email;
    document.getElementById('currentTier').textContent = prettyTier(profile.tier || 'guest');
    document.getElementById('userRole').textContent = profile.role || 'user';
    document.getElementById('memberSince').textContent = profile.created_at
      ? new Date(profile.created_at).toLocaleDateString()
      : '-';
    document.getElementById('tierSelect').value = profile.tier || 'guest';

    await loadActiveOverride(profile.id);
    document.getElementById('userCard').classList.add('show');
    showMessage('User found.');
  });
  
  // Apply tier override (Supabase only)
  document.getElementById('applyOverrideBtn').addEventListener('click', async () => {
    if (!currentUserId) {
      showMessage('Search for a user first.', 'error');
      return;
    }
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    const overrideTier = document.getElementById('overrideTierSelect').value;
    const reason = document.getElementById('overrideReasonInput').value.trim() || null;
    const expiresVal = document.getElementById('overrideExpiresAt').value;
    const expires_at = expiresVal ? new Date(expiresVal).toISOString() : null;
    const email = document.getElementById('emailInput').value.trim().toLowerCase();

    const { error: err1 } = await supabase.from('tier_overrides').insert({
      user_id: currentUserId,
      override_tier: overrideTier,
      reason: reason,
      expires_at: expires_at,
      created_by: session.user.id
    });
    if (err1) {
      showMessage('Failed to set override: ' + err1.message, 'error');
      return;
    }
    const { error: err2 } = await supabase.from('audit_logs').insert({
      actor_id: session.user.id,
      action: 'TIER_OVERRIDE_SET',
      target_user_id: currentUserId,
      meta: { override_tier: overrideTier, reason: reason, expires_at: expires_at, target_email: email, actor_email: session.user.email }
    });
    if (err2) showMessage('Override set but audit log failed: ' + err2.message, 'error');
    else showMessage('Override applied and logged.', 'success');
    await loadActiveOverride(currentUserId);
    document.getElementById('overrideReasonInput').value = '';
    document.getElementById('overrideExpiresAt').value = '';
  });

  // Remove tier override (delete row + audit)
  document.getElementById('removeOverrideBtn').addEventListener('click', async () => {
    if (!currentUserId) return;
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    const email = document.getElementById('emailInput').value.trim().toLowerCase();

    const { data: overrides } = await supabase.from('tier_overrides').select('id').eq('user_id', currentUserId).or('expires_at.is.null,expires_at.gt.' + new Date().toISOString());
    if (!overrides || overrides.length === 0) {
      showMessage('No active override to remove.', 'error');
      return;
    }
    const { error: err1 } = await supabase.from('tier_overrides').delete().eq('user_id', currentUserId);
    if (err1) {
      showMessage('Failed to remove override: ' + err1.message, 'error');
      return;
    }
    await supabase.from('audit_logs').insert({
      actor_id: session.user.id,
      action: 'TIER_OVERRIDE_REMOVED',
      target_user_id: currentUserId,
      meta: { target_email: email, actor_email: session.user.email }
    });
    showMessage('Override removed and logged.', 'success');
    await loadActiveOverride(currentUserId);
  });

  // Save profile tier (member_profiles + audit_logs, no API)
  document.getElementById('saveBtn').addEventListener('click', async () => {
    if (!currentUserId) {
      showMessage('Search for a user first.', 'error');
      return;
    }
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    const newTier = document.getElementById('tierSelect').value;
    const reason = document.getElementById('reasonInput').value.trim();
    if (!reason) {
      showMessage('Reason is required for audit.', 'error');
      return;
    }
    const email = document.getElementById('emailInput').value.trim().toLowerCase();

    const { error: err1 } = await supabase.from('member_profiles').update({ tier: newTier, updated_at: new Date().toISOString() }).eq('id', currentUserId);
    if (err1) {
      showMessage('Failed to update profile tier: ' + err1.message, 'error');
      return;
    }
    const { error: err2 } = await supabase.from('audit_logs').insert({
      actor_id: session.user.id,
      action: 'TIER_CHANGE',
      target_user_id: currentUserId,
      meta: { new_tier: newTier, reason: reason, target_email: email, actor_email: session.user.email }
    });
    if (err2) showMessage('Profile updated but audit log failed: ' + err2.message, 'error');
    else showMessage('Profile tier updated and logged.', 'success');
    document.getElementById('currentTier').textContent = prettyTier(newTier);
  });

  document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('userCard').classList.remove('show');
    document.getElementById('emailInput').value = '';
  });

  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
      btn.classList.add('active');
      const el = document.getElementById('tab-' + tab);
      if (el) { el.classList.add('active'); el.style.display = 'block'; }
      document.querySelectorAll('.tab-content').forEach(s => {
        if (!s.classList.contains('active')) s.style.display = 'none';
      });
    });
  });

  // Audit log load (audit_logs table; RLS: admins can read)
  document.getElementById('auditLoadBtn').addEventListener('click', async () => {
    const action = document.getElementById('auditActionFilter').value;
    const targetEmail = document.getElementById('auditTargetEmail').value.trim();
    const dateFrom = document.getElementById('auditDateFrom').value;
    const dateTo = document.getElementById('auditDateTo').value;
    const tbody = document.getElementById('auditTableBody');
    const loadingEl = document.getElementById('auditLoading');
    tbody.innerHTML = '';
    loadingEl.style.display = 'block';
    let query = supabase.from('audit_logs').select('*').order('created_at', { ascending: false }).limit(500);
    if (action) query = query.eq('action', action);
    if (dateFrom) query = query.gte('created_at', dateFrom + 'T00:00:00Z');
    if (dateTo) query = query.lte('created_at', dateTo + 'T23:59:59Z');
    const { data: rawRows, error } = await query;
    let rows = rawRows || [];
    if (targetEmail) rows = rows.filter(r => (r.meta && (r.meta.target_email || '').toLowerCase().includes(targetEmail.toLowerCase())));
    loadingEl.style.display = 'none';
    if (error) {
      showMessage('Failed to load audit log: ' + error.message, 'error');
      return;
    }
    (rows || []).forEach(r => {
      const meta = r.meta || {};
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid rgba(255,255,255,.08)';
      tr.innerHTML = '<td style="padding:10px;">' + new Date(r.created_at).toLocaleString() + '</td>' +
        '<td style="padding:10px;">' + escapeHtmlAttr(r.action || '-') + '</td>' +
        '<td style="padding:10px;">' + escapeHtmlAttr(meta.actor_email || r.actor_id || '-') + '</td>' +
        '<td style="padding:10px;">' + escapeHtmlAttr(meta.target_email || r.target_user_id || '-') + '</td>' +
        '<td style="padding:10px;max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="' + escapeHtmlAttr(JSON.stringify(meta)) + '">' + escapeHtmlAttr(meta.reason || meta.override_tier || '-') + '</td>';
      tbody.appendChild(tr);
    });
  });

  // Grant entitlement via Supabase (member products; reason required)
  document.getElementById('grantForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('grantEmail').value.trim().toLowerCase();
    const product_key = document.getElementById('grantProductKey').value;
    const reason = document.getElementById('grantReason').value.trim();
    const expiresVal = document.getElementById('grantExpiresAt').value;
    const expires_at = expiresVal ? new Date(expiresVal).toISOString() : null;
    if (!reason) {
      showMessage('Reason is required for every grant.', 'error');
      return;
    }
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    const { data: profile } = await supabase.from('member_profiles').select('id').eq('email', email).single();
    const user_id = profile?.id || null;
    if (!user_id) {
      showMessage('User not found in member_profiles. They must sign in once first.', 'error');
      return;
    }
    const { error: err1 } = await supabase.from('entitlements').insert({
      user_id,
      email,
      product_key,
      status: 'active',
      expires_at: expires_at || null,
      source: 'admin_grant'
    });
    if (err1) {
      showMessage('Failed to grant: ' + err1.message, 'error');
      return;
    }
    await supabase.from('audit_logs').insert({
      actor_id: session.user.id,
      action: 'GRANT',
      target_user_id: user_id,
      meta: { product_key, reason, target_email: email, actor_email: session.user.email }
    });
    showMessage('Entitlement granted.', 'success');
    document.getElementById('grantEmail').value = '';
    document.getElementById('grantExpiresAt').value = '';
    document.getElementById('grantReason').value = '';
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login.html';
  });

  // Usage analytics (RLS: admins can select usage_logs)
  let usageRows = [];
  document.getElementById('usageLoadBtn').addEventListener('click', async () => {
    const tbody = document.getElementById('usageTableBody');
    const loadingEl = document.getElementById('usageLoading');
    const statsEl = document.getElementById('usageStats');
    tbody.innerHTML = '';
    loadingEl.style.display = 'block';
    statsEl.style.display = 'none';
    const { data: rows, error } = await supabase
      .from('usage_logs')
      .select('tool, created_at')
      .order('created_at', { ascending: false })
      .limit(5000);
    loadingEl.style.display = 'none';
    if (error) {
      showMessage('Failed to load usage: ' + error.message, 'error');
      return;
    }
    usageRows = rows || [];
    const byTool = {};
    usageRows.forEach(r => {
      byTool[r.tool] = (byTool[r.tool] || 0) + 1;
    });
    const sorted = Object.entries(byTool).sort((a, b) => b[1] - a[1]);
    sorted.forEach(([tool, count]) => {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid rgba(255,255,255,.08)';
      tr.innerHTML = '<td style="padding:10px;">' + tool + '</td><td style="padding:10px;text-align:right;">' + count + '</td>';
      tbody.appendChild(tr);
    });
    document.getElementById('usageTotal').textContent = 'Total events: ' + usageRows.length + ' (last 5000)';
    statsEl.style.display = 'block';
  });

  document.getElementById('usageExportCsv').addEventListener('click', () => {
    if (usageRows.length === 0) {
      showMessage('Load usage first.', 'error');
      return;
    }
    const headers = ['tool', 'created_at'];
    const csv = [headers.join(',')].concat(
      usageRows.map(r => [r.tool, r.created_at].join(','))
    ).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'usage_logs_' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    URL.revokeObjectURL(a.href);
    showMessage('CSV exported.');
  });
})();
</script>

</body>
</html>
